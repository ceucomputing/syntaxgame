"use strict";String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var r=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>r.length)&&(t=r.length),t-=e.length;var i=r.lastIndexOf(e,t);return-1!==i&&i===t});var Tokenizer=function(e){this.source=e,this.tail=e};Tokenizer.prototype.nextToken=function(){if(0===this.tail.length)return null;var e;if("\n"===this.tail.charAt(0))e=1;else if(this.tail.charAt(0).match(/\w/))for(e=0;this.tail.charAt(e).match(/\w/);)++e;else for(e=0;this.tail.charAt(e)===this.tail.charAt(0);)++e;var t=this.tail.slice(0,e);return this.tail=this.tail.slice(e),t},Tokenizer.prototype.toTokens=function(){for(var e=[],t=this.nextToken();t;)e.push(t),t=this.nextToken();return e};var Generator=function(){this.complexity=0};Generator.prototype.strList=function(){switch(randIndex(5)){case 0:return["names","names = ['Siti', 'Alex', 'Bala']"];case 1:return["places","places = ['Home', 'School']"];case 2:return["fruits","fruits = ['Apple', 'Orange', 'Pear']"];case 3:return["s",'s = ["A", "B", "C", "D"]'];case 4:return["colours",'colours = ["red", "orange", "green", "blue"]']}},Generator.prototype.intList=function(){var e=2+randIndex(3),t=" = [";switch(randIndex(3)){case 0:for(var r=0;r<e;++r)t+=1965+randIndex(55)+", ";return t=t.slice(0,-2)+"]",["years","years"+t];case 1:for(var r=0;r<e;++r)t+=15+randIndex(84)+", ";return t=t.slice(0,-2)+"]",["ages","ages"+t];case 2:for(var r=0;r<e;++r)t+=(0==randIndex(2)?-1:1)*(1+randIndex(100))+", ";return t=t.slice(0,-2)+"]",["x","x"+t]}},Generator.prototype.floatList=function(){var e=2+randIndex(3),t=" = [";switch(randIndex(2)){case 0:for(var r=0;r<e;++r){var i=randIndex(2);t+=((0==randIndex(2)?-1:1)*(1+100*Math.random())).toFixed(i),0==randIndex(4)&&(t+=0==randIndex(2)?"e":"E",t+=(0==randIndex(2)?-1:1)*(1+randIndex(9))),t+=", "}t=t.slice(0,-2)+"]";var s=0==randIndex(2)?"readings":"y";return[s,s+t];case 1:for(var r=0;r<e;++r){var i=randIndex(2);t+=(1+100*Math.random()).toFixed(i),t+=", "}return t=t.slice(0,-2)+"]",["lengths","lengths"+t]}},Generator.prototype.numberList=function(){switch(randIndex(2)){case 0:return this.intList();case 1:return this.floatList()}},Generator.prototype.expanders={PROGRAM:function(){switch(randIndex(5)){case 0:return["@MIN"];case 1:return["@MAX"];case 2:return["@AVERAGE"];case 3:return["@SEARCH"];case 4:return["@EXTRACT"]}},MIN:function(){var e=this.numberList();switch(this.complexity){case 0:return[e[1],"@PRINT 0 Minimum min("+e[0]+")"];case 1:return[e[1],"@MIN1_PART0 "+e[0],spaces(1)+e[0]+"_min = "+e[0]+"[0]",spaces(1)+"for i in "+e[0]+":","@LT 2 if i "+e[0]+"_min",spaces(3)+e[0]+"_min = i","@PRINT 0 Minimum "+e[0]+"_min"];default:return[e[1],"@MIN2_PART0 "+e[0],spaces(1)+e[0]+"_min = "+e[0]+"[0]",spaces(1)+e[0]+"_min_index = 0",spaces(1)+"for i in range(len("+e[0]+")):","@LT 2 if "+e[0]+"[i] "+e[0]+"_min",spaces(3)+e[0]+"_min = "+e[0]+"[i]",spaces(3)+e[0]+"_min_index = i","@PRINT 0 Minimum "+e[0]+"_min","@PRINT 0 Minimum-index "+e[0]+"_min_index"]}},MIN1_PART0:function(e){switch(randIndex(2)){case 0:return["@IFLEN0 0 "+e,spaces(1)+e+"_min = None","else:"];case 1:return[e+"_min = None","@IFLENNOT0 0 "+e]}},MIN2_PART0:function(e){switch(randIndex(2)){case 0:return["@IFLEN0 0 "+e,spaces(1)+e+"_min = None",spaces(1)+e+"_min_index = None","else:"];case 1:return[e+"_min = None",e+"_min_index = None","@IFLENNOT0 0 "+e]}},MAX:function(){var e=this.numberList();switch(this.complexity){case 0:return[e[1],"@PRINT 0 Maximum max("+e[0]+")"];case 1:return[e[1],"@MAX1_PART0 "+e[0],spaces(1)+e[0]+"_max = "+e[0]+"[0]",spaces(1)+"for i in "+e[0]+":","@LT 2 if "+e[0]+"_max i",spaces(3)+e[0]+"_max = i","@PRINT 0 Maximum "+e[0]+"_max"];default:return[e[1],"@MAX2_PART0 "+e[0],spaces(1)+e[0]+"_max = "+e[0]+"[0]",spaces(1)+e[0]+"_max_index = 0",spaces(1)+"for i in range(len("+e[0]+")):","@LT 2 if "+e[0]+"_max "+e[0]+"[i]",spaces(3)+e[0]+"_max = "+e[0]+"[i]",spaces(3)+e[0]+"_max_index = i","@PRINT 0 Maximum "+e[0]+"_max","@PRINT 0 Maximum-index "+e[0]+"_max_index"]}},MAX1_PART0:function(e){switch(randIndex(2)){case 0:return["@IFLEN0 0 "+e,spaces(1)+e+"_max = None","else:"];case 1:return[e+"_max = None","@IFLENNOT0 0 "+e]}},MAX2_PART0:function(e){switch(randIndex(2)){case 0:return["@IFLEN0 0 "+e,spaces(1)+e+"_max = None",spaces(1)+e+"_max_index = None","else:"];case 1:return[e+"_max = None",e+"_max_index = None","@IFLENNOT0 0 "+e]}},AVERAGE:function(){var e=this.numberList();switch(this.complexity){case 0:return[e[1],"@IFLENNOT0 0 "+e[0],spaces(1)+e[0]+"_average = sum("+e[0]+") / len("+e[0]+")","@PRINT 1 Average "+e[0]+"_average"];default:return[e[1],"@AVERAGE1_PART0 "+e[0],spaces(1)+e[0]+"_average = 0",spaces(1)+"for i in "+e[0]+":","@AUGMENT 2 "+e[0]+"_average + i","@AUGMENT 1 "+e[0]+"_average / len("+e[0]+")","@PRINT 0 Average "+e[0]+"_average"]}},AVERAGE1_PART0:function(e){switch(randIndex(2)){case 0:return["@IFLEN0 0 "+e,spaces(1)+e+"_average = None","else:"];case 1:return[e+"_average = None","@IFLENNOT0 0 "+e]}},SEARCH:function(){var e=this.strList();switch(this.complexity){case 0:return[e[1],"search = input('Enter search: ')",e[0]+"_result = search in "+e[0],"@PRINT 0 Search "+e[0]+"_result"];default:return[e[1],"search = input('Enter search: ')","@SEARCH1_PART0 "+e[0],"@PRINT 0 Search "+e[0]+"_index"]}},SEARCH1_PART0:function(e){switch(randIndex(2)){case 0:return[e+"_index = None","for i in range(len("+e+")):",spaces(1)+"if "+e+"[i] == search:",spaces(2)+e+"_index = i",spaces(2)+"break"];case 1:return[e+"_index = None","i = 0","@LT 0 while i len("+e+")",spaces(1)+"if "+e+"[i] == search:",spaces(2)+e+"_index = i",spaces(2)+"break","@AUGMENT 1 i + 1"]}},EXTRACT:function(){switch(this.complexity){case 0:var e=this.strList();return[e[1],e[0]+"_extract = []","@EXTRACT_PART0 STR "+e[0],"@PRINT 0 Extract "+e[0]+"_extract"];default:var t=this.intList(),r=this.intList();return r[1]="other"+r[1].slice(r[0].length),r[0]="other",[t[1],r[1],t[0]+"_extract = []","@EXTRACT_PART0 LIST "+t[0]+" "+r[0],"@PRINT 0 Extract "+t[0]+"_extract"]}},EXTRACT_PART0:function(e,t,r){switch(randIndex(3)){case 0:return["for i in range(len("+t+")):","@IF"+e+" 1 "+t+"[i]"+(r?" "+r:""),"@AUGMENT 2 "+t+"_extract + "+t+"[i:i+1]"];case 1:return["i = 0","@LT 0 while i len("+t+")","@IF"+e+" 1 "+t+"[i]"+(r?" "+r:""),"@AUGMENT 2 "+t+"_extract + ["+t+"[i]]","@AUGMENT 1 i + 1"];case 2:return["for i in "+t+":","@IF"+e+" 1 i"+(r?" "+r:""),"@AUGMENT 2 "+t+"_extract + [i]"]}},IFSTR:function(e,t){var r,i=spaces(e);switch(randIndex(6)){case 0:r="isalpha";break;case 1:r="isalnum";break;case 2:r="isdigit";break;case 3:r="isspace";break;case 4:r="islower";break;case 5:r="isupper"}return[i+"if "+t+"."+r+"():"]},IFLIST:function(e,t,r){return[spaces(e)+"if "+t+" in "+r+":"]},IFLEN0:function(e,t){var r=spaces(e);switch(randIndex(2)){case 0:return[r+"if len("+t+") == 0:"];case 1:return[r+"if "+t+" == []:"]}},IFLENNOT0:function(e,t){var r=spaces(e);switch(randIndex(3)){case 0:return[r+"if len("+t+") != 0:"];case 1:return[r+"if len("+t+") > 0:"];case 2:return[r+"if "+t+" != []:"]}},LT:function(e,t,r,i){var s=spaces(e);switch(randIndex(2)){case 0:return[s+t+" "+r+" < "+i+":"];case 1:return[s+t+" "+i+" > "+r+":"]}},PRINT:function(e,t,r){var i=spaces(e);switch(randIndex(2)){case 0:return[i+"print("+r+")"];case 1:return[i+"print('"+t+": ' + str("+r+"))"]}},AUGMENT:function(e,t,r,i){var s=spaces(e);switch(randIndex(2)){case 0:return[s+t+" "+r+"= "+i];case 1:return[s+t+" = "+t+" "+r+" "+i]}}},Generator.prototype.generateProgram=function(){var e,t=["@PROGRAM"];do{e=!1;for(var r=t.length-1;r>=0;--r){var i=t[r];if("@"==i.charAt(0)){e=!0;var s=i.slice(1).split(" "),n=this.expanders[s[0]].apply(this,s.slice(1));Array.prototype.splice.apply(t,[r,1].concat(n))}}}while(e);return t};var Game=function(e){this.CORRECT=10,this.WRONG=-5,this.lines=[],this.correctionsByLine=[],this.sourceElement=$("#source"),this.score=0,this.scoreElement=$("#score"),this.level=0,this.levelElement=$("#level"),this.timer=null,this.timeLeft=0,this.timeElement=$("#timeleft"),this.errorsTotal=0,this.errorsFound=0,this.errorsFoundElement=$("#errorsfound"),this.errorsLeftElement=$("#errorsleft"),this.rightOverlay=$("#right-overlay"),this.wrongOverlay=$("#wrong-overlay"),this.bannerOverlay=$("#banner-overlay"),this.bannerOverlayLevel=$("#banner-overlay span"),this.reportOverlay=$("#report-overlay"),this.reportOverlayScore=$("#report-overlay span"),this.archive=[],this.previousArchiveElement=$("#archive-prev"),this.nextArchiveElement=$("#archive-next"),this.am=e,this.generator=new Generator};Game.prototype.start=function(){this.archive=[],this.hideArchive(),this.setScore(0),this.setLevel(0),this.nextLevel()},Game.prototype.clickHandler=function(e,t,r){if(null!==this.timer){var i=this;bootbox.prompt({title:"What do you think this should be?",value:r.text(),callback:function(s){if(null!==s&&(s=s.trim())!==r.text().trim()){for(var n=i.correctionsByLine[e],a=0;a<n.length;++a){var o=n[a];if(t===o[0]&&s===o[1].trim())return i.correctionsByLine[e]=[],r.text(o[1]),r.addClass("correct"),r.off("click"),i.incrementScore(i.CORRECT),i.incrementErrorsFound(),poof(i.rightOverlay,lastMoveEvent),void i.am.playEffect("ding")}i.incrementScore(i.WRONG),poof(i.wrongOverlay,lastMoveEvent),i.am.playEffect("buzzer"),i.clickHandler(e,t,r)}}}).init(function(){$(".bootbox-input").select()})}},Game.prototype.setSource=function(e){var t=this,r=new Tokenizer(e);this.lines=splitArray(r.toTokens(),"\n"),this.correctionsByLine=[];for(var i=[],s=0;s<this.lines.length;++s)this.correctionsByLine.push([]),i.push(this.lines[s].slice());for(var n=[],s=0;s<i.length;++s){var a=errorify(i[s]);a.length>0&&n.push([s,a])}n.length<=this.errorsTotal&&this.setErrorsTotal(n.length);for(var s=0;s<this.errorsTotal;++s){var o=s+randIndex(n.length-s),c=n[s];n[s]=n[o],n[o]=c;var h=n[s];this.lines[h[0]]=i[h[0]],this.correctionsByLine[h[0]]=h[1]}this.sourceElement.html("");for(var s=0;s<this.lines.length;++s)for(var l=this.lines[s],u=0;u<l.length;++u){var m=l[u];if(m.match(/\s/))this.sourceElement.append(document.createTextNode(m));else{for(var p=$("<a>",{href:"#",text:m,click:function(){var e=s,r=u;return function(i){return t.clickHandler(e,r,$(i.target)),!1}}()}),a=this.correctionsByLine[s],f=0;f<a.length;++f){var d=a[f];if(u==d[0]){d.push(p);break}}this.sourceElement.append(p)}}},Game.prototype.setScore=function(e){this.score=e,this.scoreElement.text(e)},Game.prototype.incrementScore=function(e){this.setScore(this.score+e)},Game.prototype.clearTimer=function(e){this.timer&&(clearInterval(this.timer),this.timer=null),this.sourceElement.addClass("disabled")},Game.prototype.setTimer=function(e){this.clearTimer(),this.setTimeLeft(e),this.timer=setInterval(this.handleTick.bind(this),1e3),this.sourceElement.removeClass("disabled")},Game.prototype.setTimeLeft=function(e){this.timeLeft=e;var t=Math.floor(e/60),r=e%60;t=t<10?"0"+t:t.toString(),r=r<10?"0"+r:r.toString(),this.timeElement.text(t+":"+r)},Game.prototype.handleTick=function(){if(this.setTimeLeft(this.timeLeft-1),0==this.timeLeft){this.clearTimer(),bootbox.hideAll();for(var e=0;e<this.correctionsByLine.length;++e){var t=this.correctionsByLine[e];if(t.length>0){t[0][2].addClass("wrong")}}return this.archive.push(this.sourceElement.html()),this.sourceElement.html(this.archive[this.archive.length-1]),this.showArchive(),this.reportOverlayScore.text(this.score),bootbox.alert({className:"modal-report",title:"Time's Up!",message:this.reportOverlay.html()}),this.am.playEffect("ding"),void this.am.play("report")}this.timeLeft<=5&&(flashOpacity(this.timeElement),this.am.playEffect("alarm")),this.am.playEffect("tick")},Game.prototype.setErrorsTotal=function(e){this.errorsTotal=e,this.errorsLeftElement.text(this.errorsTotal-this.errorsFound)},Game.prototype.setErrorsFound=function(e){this.errorsFound=e,this.errorsFoundElement.text(this.errorsFound),this.errorsLeftElement.text(this.errorsTotal-this.errorsFound)},Game.prototype.setLevel=function(e){this.level=e,this.levelElement.text(e)},Game.prototype.incrementErrorsFound=function(){this.setErrorsFound(this.errorsFound+1),this.errorsFound==this.errorsTotal&&(this.clearTimer(),this.archive.push(this.sourceElement.html()),this.nextLevel())},Game.prototype.nextLevel=function(){this.setLevel(this.level+1),this.generator.complexity=Math.floor(this.level/5);var e=this.generator.generateProgram(),t=Math.floor(e.length*this.level/(this.level+15));this.setErrorsTotal(Math.max(1,t)),this.setErrorsFound(0),e=e.join("\n"),this.setSource(e);var r=30;this.level>=15&&(r=Math.floor(r/Math.pow(1.1,this.level-15)));var i=this;this.bannerOverlayLevel.text(this.level),flash(this.bannerOverlay,function(){i.setTimer(Math.max(1,r)),i.am.playEffect("harp")}),this.am.playEffect("swoosh")},Game.prototype.previousArchive=function(){this.level-1<1||(this.setLevel(this.level-1),this.sourceElement.html(this.archive[this.level-1]),this.showArchive())},Game.prototype.nextArchive=function(){this.level+1>this.archive.length||(this.setLevel(this.level+1),this.sourceElement.html(this.archive[this.level-1]),this.showArchive())},Game.prototype.hideArchive=function(){this.previousArchiveElement.hide(),this.nextArchiveElement.hide()},Game.prototype.showArchive=function(){this.previousArchiveElement.show(),this.nextArchiveElement.show(),this.level==this.archive.length?this.setErrorsFound(this.errorsFound):(this.errorsFoundElement.text("-"),this.errorsLeftElement.text("-")),this.level-1<1?this.previousArchiveElement.addClass("disabled"):this.previousArchiveElement.removeClass("disabled"),this.level+1>this.archive.length?this.nextArchiveElement.addClass("disabled"):this.nextArchiveElement.removeClass("disabled")};var AudioManager=function(){this.currentMusic=null,this.music={menu:$("#menu-music")[0],game:$("#game-music")[0],report:$("#report-music")[0]};for(var e in this.music)this.music[e].loop=!0;this.effects={swoosh:$("#swoosh-effect")[0],tick:$("#tick-effect")[0],alarm:$("#alarm-effect")[0],ding:$("#ding-effect")[0],buzzer:$("#buzzer-effect")[0],harp:$("#harp-effect")[0]}};AudioManager.prototype.play=function(e){this.currentMusic!==this.music[e]&&(null!==this.currentMusic&&this.currentMusic.pause(),this.currentMusic=this.music[e],this.currentMusic.currentTime=0,this.currentMusic.play())},AudioManager.prototype.stop=function(){null!==this.currentMusic&&(this.currentMusic.pause(),this.currentMusic=null)},AudioManager.prototype.restart=function(e){this.currentMusic===this.music[e]?this.currentMusic.currentTime=0:this.play(e)},AudioManager.prototype.playEffect=function(e){this.effects[e].currentTime=0,this.effects[e].play()};var errorify=function(e){for(var t,r,i,s=[],n=!1,a=0,o=null,c=0;c<e.length;++c){var h=e[c];if(!h.match(/\s+/)){if(!n&&"#"===h)break;if("'"===h||'"'===h)if(n&&h===t){if(c-1>=0&&e[c-1].endsWith("\\"))continue;n=!1,s.push([h,[r,c],1,["'"===h?'"':"'"]])}else n=!0,t=h,r=c;if(!n){switch(h){case":":for(var l=!0,u=c+1;u<e.length;++u)if(!e[u].match(/\s+/)){l=!1;break}if(l&&null!==o){var m=o+h;s.push([m,[i],c-i+1,[o]])}s.push([h,[c],1,[";"]]);break;case"True":s.push([h,[c],1,["true","TRUE"]]);break;case"False":s.push([h,[c],1,["false","FALSE"]]);break;case"None":s.push([h,[c],1,["none","NONE"]]);break;case"break":s.push([h,[c],1,["brake","braek"]]);break;case"while":s.push([h,[c],1,["when","where","which"]]);break;case"for":s.push([h,[c],1,["four","fur","fore"]]);break;case"if":s.push([h,[c],1,["in","is","of","iif","iff"]]);break;case"in":s.push([h,[c],1,["of","on","if","iin","inn"]]);break;case"and":s.push([h,[c],1,["&&"]]);break;case"or":s.push([h,[c],1,["||"]]);break;case"not":var m=h,p=c+1<e.length&&e[c+1].match(/\s+/);p&&(m+=e[c+1]),s.push([m,[c],p?2:1,["!"]]);break;case"%":s.push([h,[c],1,["%%","mod"]]);break;case"==":s.push([h,[c],1,["="]]);break;case",":s.push([h,[c],1,[".",";",",,"]]);break;case".":0==a&&s.push([h,[c],1,["..",","]]);break;case"!":c+1<e.length&&"="===e[c+1]&&s.push(["!=",[c],2,["<>","!=="]])}if(h.charAt(0).match(/\(|\)/)){var f;switch(h.charAt(0)){case"(":f="[";break;case")":f="]"}var d=[f+h.slice(1)];h.length>1&&(d.push(h.slice(1)+f),d.push(h.slice(1))),s.push([h,[c],1,d])}if(h.charAt(0).match(/\[|\]/)){for(var u=0;u<h.length;++u)switch(h.charAt(u)){case"[":++a;break;case"]":--a}h.length>1&&s.push([h,[c],1,[h.slice(1)]])}o=h,i=c}}}if(0===s.length)return[];var v=s[randIndex(s.length)],x=v[1][randIndex(v[1].length)],g=v[3][randIndex(v[3].length)];e.splice(x,v[2],g);var y=[[x,v[0]]];if(v[1].length>1)for(var u=0;u<v[1].length;++u)v[1][u]!=x&&y.push([v[1][u],g]);return y},splitArray=function(e,t){for(var r=[],i=[],s=0;s<e.length;++s){var n=e[s];i.push(n),n===t&&(r.push(i),i=[])}return r.push(i),r},spaces=function(e){for(var t="";e>0;)t+="    ",--e;return t},randIndex=function(e){return Math.floor(Math.random()*e)},flash=function(e,t){var r=bootbox.dialog({className:"modal-banner",message:e.html(),closeButton:!1});setTimeout(function(){r.modal("hide"),t&&t()},1e3)},poof=function(e,t){e.show();var r=t.pageX-e.innerWidth()/2,i=t.pageY-e.innerHeight()/2;e.css({opacity:1}),e.offset({left:r,top:i}),e.animate({top:i-100,opacity:0},{duration:500,complete:function(){e.hide()}})},flashOpacity=function(e){e.animate({opacity:0},{duration:100,complete:function(){e.animate({opacity:1},100)}})},am,game,lastMoveEvent;$(document).ready(function(){am=new AudioManager,$("#menu-music").on("loadedmetadata",function(){am.play("menu")}),game=new Game(am);var e=$("#title"),t=$("#game");$(document).on("mousemove",function(e){lastMoveEvent=e}),$("#start").on("click",function(){e.slideUp(),t.slideDown(),game.start(),am.play("game")}),$("#archive-prev").on("click",function(){game.previousArchive()}),$("#archive-next").on("click",function(){game.nextArchive()}),$("#restart").on("click",function(){game.start(),am.restart("game")}),$("#quit").on("click",function(r){game.clearTimer(),t.slideUp(),e.slideDown(),am.play("menu")}),$("#howtoplay").on("click",function(e){am.stop(),bootbox.alert({title:"How to Play",message:$("#howtoplay-overlay").html(),callback:function(){am.play("menu")}})}),$("#credits").on("click",function(e){bootbox.alert({title:"Credits",message:$("#credits-overlay").html()})})});